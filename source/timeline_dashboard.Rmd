---
title: "Untitled"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny 
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(timevis)
library(timelineS)
library(plotly)
library(readxl)
```

```{r}
summ_dat = readxl::read_excel("../Data/Summary_stats_all.xlsx", 
                   sheet = "Summary_stats_all_locs", col_names = TRUE) %>%
  janitor::clean_names() %>%
  select(-check, -notes, -link, -nursing_exorder, -exorder_date, -funding, -nursing_novis,
         -covid_reg, -testing, -nursing_notes, -phase_opening, -phase_number, -phase_total,
         -reopening_type, -x91, -any_business_start_date, -any_business_end_date,
         -all_non_ess_business_start_date, -all_non_ess_business_end_date) %>% 
  # outdoor type needs to be manipulated differently
  rename(state = location_name) %>%
  select(-close_contact_75, -gather_no_restrict, -summer_school) %>%
  mutate(religious_25_capacity = as.Date(as.numeric(religious_25_capacity), origin = "1899-12-30")) %>%
  # combine events of the same group with the same date
  pivot_longer(c(religious_25_capacity:outdoor, 
                 elective_surgery:stay_home_start_date, 
                 stay_home_end_date:any_gathering_restrict_start_date,
                 religious_gatherings,
                 any_gathering_restrict_end_date:office_50),
               names_to = "event",
               values_to = "date",
               values_drop_na = TRUE) %>%
  mutate(outdoor_type = ifelse(event == "outdoor", outdoor_type, NA),
         religion_essential = ifelse(event == "stay_home_start_date", religion_essential, NA),
         gathering_limit = ifelse(event == "any_gathering_restrict_start_date", gathering_limit, NA),
         religious_limit_capacity = ifelse(event == "religious_gatherings", religious_limit_capacity, NA),
         event = ifelse(event == "bar_33", "bars_33", 
                        ifelse(event == "religious_gatherings", "religious_gathering", event)))

# excel data change:
# as.Date(variable, origin = "1899-12-30")

cat_dat = readxl::read_excel("../Data/Summary_stats_all.xlsx", 
                   sheet = "data_dictionary", col_names = TRUE) %>%
  filter(is.na(category) == FALSE) %>%
  rename(bar_type = category,
         event = header)

# join the description and bar type to the summ data
vis_dat = left_join(summ_dat, cat_dat, by = "event") %>%
  arrange(state, bar_type, date) %>%
  mutate(date = as.Date(date, format = "%Y-%m-%d"),
         end = if_else(lead(bar_type) == bar_type & lead(date) == date,
                       Sys.Date(), 
                       if_else(lead(bar_type) == bar_type,
                               lead(date), Sys.Date()))) %>%
  rename(start = date,
         content = event,
         group = bar_type,
         title = description)

# try to combine what has the same start date

# function to put all dates of the same group into one line
# coalesce_by_column <- function(df) {
#   return(dplyr::coalesce(!!! as.list(df)))
# }
# 
# vis_dat2 = vis_dat %>%
#   select(state, content, start, group) %>%
#   mutate(row = row_number()) %>%
#   pivot_wider(names_from = content,
#               values_from = start) %>%
#   select(-row) %>%
#   group_by(state, group) %>%
#   summarise_all(coalesce_by_column)

group_dat = tibble(
  id = c("education", "gathering restrictions", "stay at home order"),
  content = c("Education", "Gathering Restrictions", "Stay at Home Order")
)
```

Inputs {.sidebar}
-----------------------------------------------------------------------
   
```{r}
states = vis_dat %>% distinct(state) %>% pull()

selectInput(
  "state_choice",
  label = h3("Select State"),
  choices = states, selected = "Alabama"
)
```

Column {.tabset}
-----------------------------------------------------------------------

### Timeline 1-timelineG

```{r}
renderPlotly({
  ggplotly(vis_dat %>%
  filter(state == input$state_choice) %>%
  timelineG(start = "start", end = "end", names = "group", phase = "title") +
    theme_classic() +
    theme(legend.position = 'none')) 
#  %>%
 #   layout(showlegend = FALSE)
})
```

### Timeline 2-ggplot

```{r}
renderPlotly({
  ggplotly(
  vis_dat %>%
  filter(state == input$state_choice) %>%
  ggplot(aes(x = start, 
             xend = end,
             y = title,
             yend = title,
             color = group)) +
  geom_segment(size = 3) +
  xlab("Date") +
  ylab("Event") +
  # this doesn't work: theme(axis.text.y = element_blank()) +
  theme_classic()
)
})
```

