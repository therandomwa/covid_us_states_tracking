---
title: "Daily COVID-19 Cases and Deaths by State"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(rvest)
library(httr)
library(plotly)
library(vistime)
```


```{r}
# read in case data
cases = read_csv("https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_confirmed_usafacts.csv", col_names = TRUE) %>%
  janitor::clean_names() %>%
  pivot_longer(starts_with("x"),
               names_to = "date",
               values_to = "total_cases") %>%
  mutate(date = substr(date, 2, 8),
         date = str_replace_all(date, "_", "/"),
         date = as.Date(date, "%m/%d/%y")) %>%
  group_by(state, date) %>%
  summarize(total_cases = sum(total_cases)) %>%
  group_by(state) %>%
  mutate(new_cases = if_else(date != "2020-01-22", total_cases - lag(total_cases), total_cases))

# read in death data
deaths = read_csv("https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_deaths_usafacts.csv", col_names = TRUE) %>%
  janitor::clean_names() %>%
  pivot_longer(starts_with("x"),
               names_to = "date",
               values_to = "total_deaths") %>%
  mutate(date = substr(date, 2, 8),
         date = str_replace_all(date, "_", "/"),
         date = as.Date(date, "%m/%d/%y")) %>%
  group_by(state, date) %>%
  summarize(total_deaths = sum(total_deaths)) %>%
  group_by(state) %>%
  mutate(new_deaths = if_else(date != "2020-01-22", total_deaths - lag(total_deaths), total_deaths)) 

# read in pop data
pop = read_csv("https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_county_population_usafacts.csv", col_names = TRUE) %>%
  janitor::clean_names() %>%
  group_by(state) %>%
  summarize(population = sum(population))

# join population counts to cases and deaths datasets for normalized counts
cases2 = left_join(cases, pop, by = "state") %>%
  mutate(new_cases_norm = (new_cases/population)*100000) %>%
  select(state, date, new_cases, new_cases_norm) %>%
  pivot_longer(new_cases:new_cases_norm,
               names_to = "num_type",
               values_to = "val") %>%
  mutate(num_type = if_else(num_type == "new_cases", "Count", "Per 100k")) %>%
  arrange(state, num_type, date) %>%
  mutate(roll_avg = (val + lag(val) + lag(lag(val)))/3) %>%
  mutate(roll_avg = ifelse(num_type != lag(num_type) | num_type != lag(lag(num_type)), NA, roll_avg))


deaths2 = left_join(deaths, pop, by = "state") %>%
  mutate(new_deaths_norm = (new_deaths/population)*100000) %>%
  select(state, date, new_deaths, new_deaths_norm) %>%
  pivot_longer(new_deaths:new_deaths_norm,
               names_to = "num_type",
               values_to = "val") %>%
  mutate(num_type = if_else(num_type == "new_deaths", "Count", "Per 100k")) %>%
  arrange(state, num_type, date) %>%
  mutate(roll_avg = (val + lag(val) + lag(lag(val)))/3) %>%
  mutate(roll_avg = ifelse(num_type != lag(num_type) | num_type != lag(lag(num_type)), NA, roll_avg)) 


state_string = cases2 %>% distinct(state) %>% pull()

# make temporary timeline dataset to test timeline visual-must have full data from same start date as cases and deaths
timelines = tibble(
  state = rep(state_string, 2),
  start = c(rep("1/22/2020", 51), rep("5/01/2020", 25), rep("5/15/2020", 26)),
  event = c(rep("closed", 51), rep("open", 51)),
  end = c(rep("5/1/2020", 25), rep("5/15/2020", 26), rep("05/17/2020", 51))
) %>%
  mutate(start = as.Date(start, "%m/%d/%y"),
         end = as.Date(end, "%m/%d/%y"))

timelines2 = tibble(
  state = state_string,
  start_close = c(rep("2/15/2020", 25), rep("3/15/2020", 26)),
  end_close = c(rep("5/1/2020", 25), rep("5/15/2020", 26)),
  start_open = c(rep("5/1/2020", 25), rep("5/15/2020", 26)),
  end_open = rep("5/18/2020", 51)
) %>%
  mutate(start_close = as.Date(start_close, "%m/%d/%y"),
         end_close = as.Date(end_close, "%m/%d/%y"),
         start_open = as.Date(start_open, "%m/%d/%y"),
         end_open = as.Date(end_open, "%m/%d/%y"))

cases3 = left_join(cases2, timelines2, by = "state")
deaths3 = left_join(deaths2, timelines2, by = "state")
```

Column {.sidebar}
-----------------------------------------------------------------------
```{r}
states = cases3 %>% distinct(state) %>% pull()

selectInput(
  "state_choice",
  label = h3("Select State"),
  choices = states, selected = "AK"
)
```

```{r}
radioButtons(
  "count_choice",
  label = h3("Select Count Type"),
  choices = c("Count", "Per 100k"), selected = "Count"
)
```

```{r}
states_grp = cases3 %>% distinct(state) %>% pull()

checkboxGroupInput(
  "group_choice",
  label = h3("Select States to Compare Over Time"),
  choices = states_grp, selected = c("AK", "AL", "AR", "AZ")
)
```



Column {data-width=500}
-----------------------------------------------------------------------

### New COVID-19 Cases by Day with 3 Day Average

```{r}
renderPlotly({
  cases3 %>%
    filter(state == input$state_choice,
           num_type == input$count_choice) %>%
    mutate(max_val = max(val)) %>%
    plot_ly(
      x = ~date, y = ~val, type = "bar", showlegend = FALSE,
      hoverinfo = "text",
      text = ~paste0("Date: ", date, '\nCases: ', round(val, 2), '\n3 Day Avg: ', round(roll_avg, 2))) %>%
    layout(
      xaxis = list(title = "Date"),
      yaxis = list(title = "No. Cases"),
      shapes = list(
        list(
          type = "rect",
          fillcolor = "yellow", line = list(color = "yellow"), opacity = 0.3,
          x0 = ~start_close, x1 = ~end_close, xref = "x",
          y0 = 0, y1 = ~max_val, yref = "y"
        ),
        list(
          type = "rect",
          fillcolor = "gray", line = list(color = "gray"), opacity = 0.3,
          x0 = ~start_open, x1 = ~end_open, xref = "x",
          y0 = 0, y1 = ~max_val, yref = "y"
        ))
      ) %>%
    add_lines(y = ~roll_avg, 
              line = list(color = "orange"))
})
```


### New COVID-19 Deaths by Day with 3 Day Average

```{r}
renderPlotly({
  deaths3 %>%
    filter(state == input$state_choice,
           num_type == input$count_choice) %>%
    mutate(max_val = max(val)) %>%
    plot_ly(
      x = ~date, y = ~val, type = "bar", showlegend = FALSE,
      hoverinfo = "text",
      text = ~paste("Date: ", date, '\nDeaths: ', round(val, 2), '\n3 Day Avg: ', round(roll_avg, 2))
    ) %>%
    layout(
      xaxis = list(title = "Date"),
      yaxis = list(title = "No. Deaths")
    ) %>%
    layout(
      shapes = list(
        list(
          type = "rect",
          fillcolor = "yellow", line = list(color = "yellow"), opacity = 0.3,
          x0 = ~start_close, x1 = ~end_close, xref = "x",
          y0 = 0, y1 = ~max_val, yref = "y"
        ),
        list(
          type = "rect",
          fillcolor = "gray", line = list(color = "gray"), opacity = 0.3,
          x0 = ~start_open, x1 = ~end_open, xref = "x",
          y0 = 0, y1 = ~max_val, yref = "y"
        ))
    ) %>%
    add_lines(y = ~roll_avg, 
              line = list(color = "orange"))
})
```


Column {data-width=500}
-----------------------------------------------------------------------

### 3 Day Average of COVID-19 Cases by Day and State

```{r}
renderPlotly({
 cases2 %>%
    filter(state %in% input$group_choice,
           num_type == input$count_choice) %>%
    plot_ly(
      x = ~date, y = ~roll_avg, color = ~state, 
      type = "scatter", mode = "lines"
    ) %>%
    layout(
      xaxis = list(title = "Date"),
      yaxis = list(title = "New COVID-19 Cases")
    )
})
```

### 3 Day Average of COVID-19 Deaths by Day and State

```{r}
renderPlotly({
 deaths2 %>%
    filter(state %in% input$group_choice,
           num_type == input$count_choice) %>%
    plot_ly(
      x = ~date, y = ~roll_avg, color = ~state, 
      type = "scatter", mode = "lines"
    ) %>%
    layout(
      xaxis = list(title = "Date"),
      yaxis = list(title = "New COVID-19 Deaths")
    )
})
```

