---
title: "COVID State Web Scraping"
output: html_document
---

# Set Up

```{r, message = FALSE, warning = FALSE }
library(tidyverse)
library(pdftools)
library(rvest)
library(lubridate)
library(readxl)
source("states.R")
source("states_constants.R")
```

# Automated States

- Oklahoma: needs demographic and ages manually entered
- Mississippi: needs age and sex manually entered
- Florida: no manual entry needed, expect long compilation
- Tennessee: no manual entry needed, but needs a date input to function
- North Carolina: needs age manually entered
- District of Columbia: no data on age available
- South Carolina: needs age and sex manually entered
- New Jersey
- New Hampshire
- Guam: no age, sex, race or ethnicity data available

## Troubleshoot States Before Compiling

```{r}
# Check with these first to make sure all states have good data
oklahoma = get_oklahoma()
mississippi = get_mississippi()
florida = get_florida()
tennessee = get_tennessee()
north_carolina = get_north_carolina()
south_carolina = get_south_carolina()
new_jersey = get_new_jersey()
new_hampshire = get_new_hampshire()
```

```{r}
```

# Compile The Automated States

```{r}
# Get as much automated data as you can
automated_data_20200520 = compile()
```

# Manual States

In addition to the information above, we need manual entry for:

- Arizona
- Hawaii
- Idaho
- Iowa
- Kansas (can automate but reading pdf crashes my RStudio?)
- Nevada: no race information
- New York: no demographic information at all
- South Dakota: have to calculate race counts from case total
- West Virginia
- Wyoming

add in count/prop
label for approximation
add in census counts for appropriate category and age
prettify the shiny
add in plots

For each of these states, we'll collect sex, age, and race information.

```{r}
# All the states we do complete manual data entry for
arizona = get_arizona() 
kansas = get_kansas()
iowa = get_iowa()
north_carolina = get_north_carolina()
hawaii = get_hawaii() # Courtney
idaho = get_idaho() # Courtney
nevada = get_nevada() 
new_york = get_new_york()
south_dakota = get_south_dakota() # Gloria
west_virginia = get_west_virginia() # Gloria 
wyoming = get_wyoming() # Amy

manual_data_20200520 = bind_rows(
  arizona,
  iowa,
  kansas,
  north_carolina,
  hawaii,
  idaho,
  nevada,
  new_york,
  south_dakota,
  west_virginia,
  wyoming
  )
```

```{r}
full_data_20200520 = bind_rows(automated_data_20200520, manual_data_20200520)
save(full_data_20200520, file = "../Data/meta_2020-05-20-cbp.rda")
```

# Compile 

```{r}
test = finalize_data("../data/raw_states/meta_final_2020-05-19.csv")
census = read_xlsx("../data/census.xlsx")
```

```{r}
totals_table = test %>% 
  select(state_name, total_test, total_case, total_death, total_hosp) %>% 
  pivot_longer(
    total_case:total_hosp,
    names_to = "total_type",
    values_to = "data_type_total"
  ) %>% 
  separate(total_type, c("prefix", "data_type")) %>% 
  select(state_name, data_type, data_type_total)

strata_values = test %>% 
  select(state_name, total_test, category, raw, strata_type, data_type)

better_test = left_join(strata_values, totals_table, by = c("state_name", "data_type")) %>% 
  distinct()
```

# Census Transformation

```{r}
census_race_sex = read_csv("../data/census.csv") %>% 
  select(NAME, TOTAL_POP:FEMALE) %>% 
  mutate(
    `AI/AN/NH/PI` = `NH.AI/AN` + `NH.NH/PI`,
    `ASIAN/PI` = `NH.ASIAN` + `NH.NH/PI`
  ) %>% 
  pivot_longer(
    TOTAL_POP:`AI/AN/NH/PI`,
    names_to = "category",
    values_to = "pop_est") %>% 
  mutate(
    new_category = case_when(
      category == "TOTAL_POP" ~ "TOTAL_POP",
      category == "NH.WHITE" ~ "NH WHITE",
      category == "ETH_HISPANIC" ~ "HISPANIC",
      category == "ETH_NH" ~ "NH",
      category == "NH.BLACK" ~ "BLACK",
      category == "NH.AI/AN" ~ "AI/AN",
      category == "NH.ASIAN" ~ "ASIAN",
      category == "NH.NH/PI" ~ "NH/PI",
      category == "AI/AN/NH/PI" ~ "AI/AN/NH/PI",
      category == "NH.MULTI" ~ "MULTI",
      category == "MALE" ~ "MALE",
      category == "FEMALE" ~ "FEMALE"
      )
  )

census_age = read_csv("../data/census.csv") %>% 
  select(NAME, AGE_0:AGE_85) %>% 
  pivot_longer(
    AGE_0:AGE_85,
    names_to = "age",
    values_to = "pop_est") %>% 
  separate(age, c("pre", "age")) %>% 
  mutate( age = as.numeric(age) )

write_csv(census_race_sex, "../data/census_race_sex.csv")
write_csv(census_age, "../data/census_age.csv")
```

