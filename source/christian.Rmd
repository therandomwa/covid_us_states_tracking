---
title: "COVID State Web Scraping"
output: html_document
---

# Set Up

```{r, message = FALSE, warning = FALSE }
library(tidyverse)
library(pdftools)
library(rvest)
library(lubridate)
library(readxl)
source("states.R")
```

# Automated States

- Oklahoma: needs demographic and ages manually entered
- Mississippi: needs age and sex manually entered
- Florida: no manual entry needed, expect long compilation
- Tennessee: no manual entry needed, but needs a date input to function
- North Carolina: needs age manually entered
- District of Columbia: no data on age available
- South Carolina: needs age and sex manually entered
- New Jersey
- New Hampshire
- Guam: no age, sex, race or ethnicity data available

## Troubleshoot States Before Compiling

```{r}
# Check with these first to make sure all states have good data
oklahoma = get_oklahoma()
mississippi = get_mississippi()
florida = get_florida()
tennessee = get_tennessee("2020-05-13")
north_carolina = get_north_carolina()
dc = get_dc()
south_carolina = get_south_carolina()
new_jersey = get_new_jersey()
new_hampshire = get_new_hampshire()
guam = get_guam()
```

```{r}
# Get as much automated data as you can
compiled_data_20200513 = compile(tn_date = "2020-05-13")
save(compiled_data_20200513, file = "../Data/meta_2020-05-13-cbp.rda")
```



# Manual States

In addition to the information above, we need manual entry for:

PR + VI + Guam + DC + 10 Manual State + 8 Automated State + 32 Aijin

- Arizona
- Hawaii
- Idaho
- Iowa
- Kansas (can automate but reading pdf crashes my RStudio?)
- Nevada: no race information
- New York: no demographic information at all
- Puerto Rico: no race data
- South Dakota: have to calculate race counts from case total
- Virgin Island
- West Virginia
- Wyoming

For each of these states, we'll collect sex, age, and race information.

```{r}


manual_fill = function(state, state_cols) {
  # Function for making it easy to fill out a skeleton
  
  # Create the skeleton from the state specific information
  skeleton = skeleton_table(state_cols)
  needed_strata = c("cases", "deaths", "hospitalized")
  
  # Get the total tested
  skeleton[["tested"]][["total"]] = readline(prompt = "Total tested?: ") %>% 
        as.numeric
  
  for (strata in needed_strata) {
    for (sc in state_cols) {
      fmt_prompt = paste0(state, ", ", strata, ", ", sc, ": ")
      skeleton[[strata]][[sc]] = readline(prompt = fmt_prompt) %>% 
        as.numeric
    }
  }
  
  return(as_tibble(skeleton))
}

test = manual_fill("Arizona", az_cols)
```

```{r}
compile_manual_states = function() {
  manual_states = c(
    "Arizona",
    "Hawaii",
    "Idaho",
    "Iowa",
    "Kansas",
    "Nevada",
    "New York",
    "Puerto Rico",
    "South Dakota",
    "Virgin Island",
    "West Virginia",
    "Wyoming")
}
```




## TODO:

- combine Aijins and your data compilation into one
- standardize Aijins data into your format
- ask to just incorporate courtneys functions into your own compiler
- create a function to make it easier to manually insert data from states that we can get all 50
